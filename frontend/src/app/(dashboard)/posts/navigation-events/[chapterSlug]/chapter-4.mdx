import { aphorisms } from '/src/api/data/aphorisms';

# The url-effect

Though the application state and the url state are obviously connected, it's not immediately
obvious what their relationship should be. In my applications, I consider the url to be the
single source of truth for **initializing** the application. In other words, when the application
initializes then the application state is derived from the url, However, once the application is
initialized, then the url is derived from the application state.

Let's consider the case where the application is loaded. The url will point to some application page that
requires a certain state that includes data (e.g. the blog-posts) and meta-data (e.g. the id of
the highlighted blog-post). Based on the current url:

- certain data needs to be fetched (I discuss this in [this post](/posts/state-providers/chapter-1));
- we must ensure that the correct post is highlighted.

Once the application is initialized then we must updates the url when the highlighted post changes.
I will use a so-called url-effect to achieve these aims:

export const code1 = `
type PropsT = {};

const DefaultProps = {
  ...dps.posts,              // of type PostT[]
  ...dps.postsHighlight,     // of type Highlight<PostT>
};

export const SyncPostWithUrlEffect = observer(
  withDefaultProps((props: PropsT & typeof DefaultProps) => {
    const { postsHighlight, posts } = props;

    const location = useLocation();
    const { postSlug } = useParams() as ObjT;
    const refUrl = React.useRef<string>('');

    React.useEffect(() => {
      // If there is a new url
      if (refUrl.current !== location.pathname) {
        const postForCurrentUrl = R.find(
          (x: PostT) => x.slug === postSlug
        )(posts);

        if (postForCurrentUrl) {
          refUrl.current = location.pathname;
          if (postsHighlight.id !== postForCurrentUrl.id) {
            postsHighlight.highlightItem({ id: postForCurrentUrl?.id });
          }
        }
      } else {
        // Check if we must update the current url based on the highlighted post.
        const post = postsHighlight.item;
        if (post && postSlug !== post.slug) {
          navToPost(post.ownerUsername, post.slug);
        }
      }
    }, [postSlug, post, posts, postsHighlight]);

    return null;
  }, DefaultProps)
);
`;

<CodeSnippet
  title="SyncPostWithUrlEffect.tsx"
  addMb
  code={code1}
/>

Note that the example code depends on some of my other libraries that are discussed in
this [post about Skandha](/posts/skandha/chapter-1) and this
[post about default properties](/posts/default-props/chapter-1). Here I will briefly
explain what these libraries do, so that you can understand the example:

- the `react-default-props-context` library provides a `withDefaultProps` function that
  can be used to define default properties for a component. The `DefaultProps` constant
  declares which default properties are used (in our case: `posts` and `postsHighlight`).
  These default properties are provided (using a React context) by a `DefaultPropsProvider`.
- the `skandha` library provides generic behaviours, such as `Highlight`. In the example
  code, we're assuming that a `Highlight` object is used to track the highlighted post.


# Inserting the url-effect in the router

The `SyncPostWithUrlEffect` must be inserted in the appropriate place in the component tree.
What we want to achieve is that the correct post is highlighted when the `PostsView` is shown.
Therefore, we will insert the `SyncPostWithUrlEffect` right above the `PostsView`.

Note that we cannot insert `SyncPostWithUrlEffect` just anywhere. It must be inserted at a
location where there is a `postSlug` url parameter, and where `posts` and `postsHighlight` are
available as default properties. Our chosen location meets these criteria.

export const code2 = `
export const UrlRouter = observer((props: PropsT) => {
  return (
    <PostsStateProvider>
      <Route path="/posts">
        <PostsView />

        <Route path="/posts/:postSlug">
          <SyncPostWithUrlEffect />
          <PostsView />
        </Route>

      </Route>
    </PostsStateProvider>
  );
});`;

<CodeSnippet
  title="UrlRouter.tsx"
  addMb
  code={code2}
/>
